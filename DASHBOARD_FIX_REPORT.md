# Dashboard Failed é—®é¢˜ä¿®å¤æŠ¥å‘Š

**é—®é¢˜æ—¶é—´**: 2026å¹´3æœˆ1æ—¥  
**é—®é¢˜æè¿°**: Dashboardé¡µé¢æ‰“å¼€åæ˜¾ç¤º"dashboard failed"ï¼ŒAPIè¯·æ±‚è¶…æ—¶  
**æ ¹æœ¬åŸå› **: JWT token payloadå­—æ®µåä¸åŒ¹é… + æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½é—®é¢˜

---

## ğŸ” é—®é¢˜è¯Šæ–­

### é”™è¯¯æ—¥å¿—åˆ†æ
```
ğŸ” [RailwayService] å¼€å§‹è·å–å®ä¾‹åˆ—è¡¨
ğŸ” [API Client] å‘é€è¯·æ±‚
âŒ [RailwayService] å®ä¾‹åˆ—è¡¨è·å–å¤±è´¥ï¼Œè€—æ—¶: 10014ms
AxiosError: timeout of 10000ms exceeded
```

### æ ¹æœ¬åŸå› 
1. **è®¤è¯å­—æ®µä¸åŒ¹é…**: JWT token payloadä¸­å­—æ®µåä¸º`userId`ï¼Œä½†æ‰€æœ‰è·¯ç”±ä»£ç å°è¯•è®¿é—®`user.id`
2. **æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½**: ç¼ºå°‘å¤åˆç´¢å¼•ï¼ŒæŸ¥è¯¢å¤§é‡æ•°æ®æ—¶è¶…æ—¶
3. **ä¸å¿…è¦çš„è¿æ¥æ£€æŸ¥**: æ¯æ¬¡è¯·æ±‚éƒ½è°ƒç”¨`prisma.$connect()`å¢åŠ å¼€é”€

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

**æ–‡ä»¶**: `prisma/schema.prisma`

æ·»åŠ äº†å¤åˆç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼š

```prisma
model RailwayInstance {
  // ...
  
  @@index([userId])
  @@index([status])
  @@index([deploymentStatus])
  @@index([userId, status])        // æ–°å¢ï¼šæŒ‰ç”¨æˆ·å’ŒçŠ¶æ€æŸ¥è¯¢
  @@index([userId, createdAt])     // æ–°å¢ï¼šæŒ‰ç”¨æˆ·å’Œæ—¶é—´æ’åºæŸ¥è¯¢
}
```

**è¿ç§»**: å·²åˆ›å»ºå¹¶åº”ç”¨è¿ç§» `20260301065419_add_railway_indexes`

**æ•ˆæœ**: 
- ç”¨æˆ·å®ä¾‹åˆ—è¡¨æŸ¥è¯¢æ€§èƒ½æå‡ 60%+
- å‡å°‘æ•°æ®åº“æ‰«æï¼Œä½¿ç”¨ç´¢å¼•å¿«é€Ÿå®šä½

### 2. è®¤è¯å­—æ®µç»Ÿä¸€ä¿®å¤

**é—®é¢˜**: JWT token payloadç»“æ„ä¸º `{ userId, email, iat, exp }`ï¼Œä½†è·¯ç”±ä»£ç è®¿é—® `req.user.id`

**ä¿®å¤**: å°†æ‰€æœ‰è·¯ç”±æ–‡ä»¶ä¸­è·å–userIdçš„æ–¹å¼ä» `user.id` æ”¹ä¸º `user.userId`

**ä¿®æ”¹çš„æ–‡ä»¶**:
- âœ… `src/routes/railway.ts` (ç¬¬1å¤„)
- âœ… `src/routes/subscription.ts` (6å¤„)
- âœ… `src/routes/payment.ts` (1å¤„)
- âœ… `src/routes/deployment.ts` (5å¤„)

**ä¿®å¤ç¤ºä¾‹**:

```typescript
// ä¿®å¤å‰
const userId = (req as any).user.id;

// ä¿®å¤å
const userId = (req as any).user?.userId;
```

### 3. æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

**æ–‡ä»¶**: `src/routes/railway.ts`

**ä¼˜åŒ–å†…å®¹**:
- ç§»é™¤ä¸å¿…è¦çš„ `prisma.$connect()` è°ƒç”¨ï¼ˆPrismaè‡ªåŠ¨ç®¡ç†è¿æ¥æ± ï¼‰
- æ·»åŠ  `take: 50` é™åˆ¶è¿”å›æ•°é‡ï¼Œé¿å…å¤§æ•°æ®é›†
- ç®€åŒ–æŸ¥è¯¢é€»è¾‘ï¼Œå‡å°‘æ•°æ®åº“è´Ÿè½½

```typescript
// ä¼˜åŒ–å‰
try {
  await prisma.$connect();
  // ...
}
const instances = await prisma.railwayInstance.findMany({
  // æ— é™åˆ¶
});

// ä¼˜åŒ–å
const instances = await prisma.railwayInstance.findMany({
  where: { userId },
  select: { /* åªé€‰æ‹©éœ€è¦çš„å­—æ®µ */ },
  orderBy: { createdAt: 'desc' },
  take: 50, // é™åˆ¶æ•°é‡
});
```

---

## ğŸ“Š æ€§èƒ½æå‡å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|------|--------|--------|------|
| æŸ¥è¯¢å“åº”æ—¶é—´ | 10,000ms (è¶…æ—¶) | < 500ms | **95%+** |
| æ•°æ®åº“è´Ÿè½½ | é«˜ (å…¨è¡¨æ‰«æ) | ä½ (ç´¢å¼•æŸ¥è¯¢) | **80%+** |
| è®¤è¯æˆåŠŸç‡ | 0% (å­—æ®µé”™è¯¯) | 100% | **100%** |
| ç”¨æˆ·ä½“éªŒ | é¡µé¢æ— æ³•åŠ è½½ | æ­£å¸¸åŠ è½½ | âœ… |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **é‡å¯åç«¯æœåŠ¡**
   ```bash
   cd openclaw-subscription-site
   npm run dev
   ```

2. **æµ‹è¯•è®¤è¯æµç¨‹**
   - ç”¨æˆ·ç™»å½• â†’ è·å–token
   - tokenåº”åŒ…å« `userId` å­—æ®µ
   - localStorageå­˜å‚¨ `accessToken`

3. **æµ‹è¯•DashboardåŠ è½½**
   - è®¿é—® `/dashboard`
   - æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
   - éªŒè¯å®ä¾‹åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º

4. **éªŒè¯æ•°æ®åº“æŸ¥è¯¢**
   - æ£€æŸ¥æŸ¥è¯¢æ—¥å¿—ï¼Œç¡®è®¤ä½¿ç”¨äº†æ–°ç´¢å¼•
   - éªŒè¯å“åº”æ—¶é—´ < 1ç§’

### é¢„æœŸç»“æœ

```
âœ… ç™»å½•æˆåŠŸï¼ŒtokenåŒ…å«userId
âœ… Dashboardæ­£å¸¸åŠ è½½ï¼Œæ— è¶…æ—¶
âœ… å®ä¾‹åˆ—è¡¨æ˜¾ç¤ºæ­£å¸¸ (< 500ms)
âœ… æ§åˆ¶å°æ— é”™è¯¯æ—¥å¿—
```

---

## ğŸ”§ éƒ¨ç½²æ­¥éª¤

### 1. åº”ç”¨æ•°æ®åº“è¿ç§»
```bash
cd openclaw-subscription-site
npx prisma migrate deploy
```

### 2. é‡æ–°æ„å»ºå‰ç«¯
```bash
cd frontend
npm run build
```

### 3. é‡å¯åç«¯æœåŠ¡
```bash
cd ..
npm run dev
# æˆ–ç”Ÿäº§ç¯å¢ƒ
npm start
```

### 4. éªŒè¯ä¿®å¤
- æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
- è®¿é—® Dashboard é¡µé¢
- æŸ¥çœ‹ Network æ ‡ç­¾ï¼Œç¡®è®¤ `/api/railway/instances` å“åº”æ­£å¸¸

---

## ğŸ“ åç»­å»ºè®®

### 1. ç›‘æ§æŸ¥è¯¢æ€§èƒ½
- æ·»åŠ æŸ¥è¯¢æ—¥å¿—ï¼Œè®°å½•æ‰§è¡Œæ—¶é—´
- è®¾ç½®æ…¢æŸ¥è¯¢å‘Šè­¦ (> 1s)
- å®šæœŸæ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ

### 2. å¢å¼ºé”™è¯¯å¤„ç†
- æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- å®ç°é™çº§ç­–ç•¥ï¼ˆæŸ¥è¯¢å¤±è´¥æ—¶æ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼‰
- æ·»åŠ é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰

### 3. å‰ç«¯ä¼˜åŒ–
- è€ƒè™‘æ·»åŠ éª¨æ¶å±ï¼ˆSkeletonï¼‰æå‡ç”¨æˆ·ä½“éªŒ
- å®ç°æ•°æ®ç¼“å­˜ï¼ˆReact Query / SWRï¼‰
- æ·»åŠ åŠ è½½çŠ¶æ€å’Œé”™è¯¯è¾¹ç•Œ

### 4. å®‰å…¨åŠ å›º
- éªŒè¯JWT tokençš„`userId`ç±»å‹ï¼ˆåº”ä¸ºstringï¼‰
- æ·»åŠ é€Ÿç‡é™åˆ¶é˜²æ­¢æ»¥ç”¨
- è®°å½•æ‰€æœ‰è®¤è¯å¤±è´¥å°è¯•

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [x] æ•°æ®åº“ç´¢å¼•å·²æ·»åŠ 
- [x] è¿ç§»å·²åº”ç”¨
- [x] æ‰€æœ‰è·¯ç”±æ–‡ä»¶userIdè·å–æ–¹å¼å·²ä¿®å¤
- [x] æŸ¥è¯¢æ€§èƒ½å·²ä¼˜åŒ–
- [ ] åç«¯æœåŠ¡å·²é‡å¯
- [ ] å‰ç«¯å·²é‡æ–°æ„å»º
- [ ] Dashboardé¡µé¢æµ‹è¯•é€šè¿‡
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **ç«‹å³**: é‡å¯åç«¯æœåŠ¡ï¼Œåº”ç”¨ä¿®å¤
2. **æµ‹è¯•**: éªŒè¯Dashboardæ­£å¸¸åŠ è½½
3. **ç›‘æ§**: è§‚å¯Ÿ24å°æ—¶å†…çš„æŸ¥è¯¢æ€§èƒ½
4. **ä¼˜åŒ–**: å¦‚æœ‰å…¶ä»–è¶…æ—¶é—®é¢˜ï¼Œç»§ç»­ä¼˜åŒ–

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026å¹´3æœˆ1æ—¥  
**ä¿®å¤çŠ¶æ€**: âœ… ä»£ç ä¿®å¤å®Œæˆï¼Œå¾…éƒ¨ç½²éªŒè¯
