# Phase 3: Railway è‡ªåŠ¨éƒ¨ç½²ç³»ç»Ÿ - å®Œæ•´å®ç°

**æ›´æ–°æ—¶é—´**: 2026å¹´2æœˆ25æ—¥  
**é¡¹ç›®é˜¶æ®µ**: Phase 3 å®Œæˆ  
**ç‰ˆæœ¬**: v3.0

---

## ğŸ“‹ æ¦‚è¿°

Phase 3 å®ç°äº†æ ¸å¿ƒçš„ Railway å®ä¾‹è‡ªåŠ¨åŒ–åˆ›å»ºç³»ç»Ÿï¼Œé‡‡ç”¨**æ–¹æ¡ˆBï¼ˆå…‹éš†æœåŠ¡ï¼‰**ï¼Œè¿™æ˜¯æœ€å¼ºçƒˆæ¨èçš„æ–¹æ¡ˆï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

âœ… **ç¯å¢ƒä¸€è‡´æ€§** - å®Œå…¨å…‹éš†æ¨¡æ¿é…ç½®  
âœ… **å¿«é€Ÿéƒ¨ç½²** - åˆ†é’Ÿçº§åˆ›å»ºå®ä¾‹  
âœ… **è‡ªåŠ¨é…ç½®** - æ— éœ€æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒ  
âœ… **å¯é ç›‘æ§** - å®Œæ•´éƒ¨ç½²è¿›åº¦è¿½è¸ª  
âœ… **æ‰©å±•çµæ´»** - æ˜“äºæ·»åŠ æ–°åŠŸèƒ½  

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒè®¾è®¡ï¼ˆæ–¹æ¡ˆB - å…‹éš†æœåŠ¡ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·è®¢é˜…ç³»ç»Ÿ                              â”‚
â”‚                  (Phase 1-2 å·²å®Œæˆ)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    åˆ›å»ºå®ä¾‹è¯·æ±‚
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            RailwayCloneService (å…‹éš†æœåŠ¡)                    â”‚
â”‚         è´Ÿè´£æ•´ä¸ªå®ä¾‹åˆ›å»ºçš„ç¼–æ’å’Œç®¡ç†                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â‘  éªŒè¯æ¨¡æ¿é¡¹ç›®      â‘¡åˆ›å»ºæ–°é¡¹ç›®    â‘¢ åˆ›å»ºç¯å¢ƒ             â”‚
â”‚  â‘£ è·å–æ¨¡æ¿é…ç½®      â‘¤ å‡†å¤‡ç¯å˜     â‘¥ åˆ›å»ºæœåŠ¡             â”‚
â”‚  â‘¦ è®¾ç½®ç¯å˜          â‘§ è§¦å‘éƒ¨ç½²     â‘¨ è®°å½•å®ä¾‹             â”‚
â”‚  â‘© å¯åŠ¨ç›‘æ§                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                    â”‚
          â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RailwayClient     â”‚         â”‚ EnvironmentVariableâ€‹Service  â”‚
â”‚  (APIäº¤äº’å±‚)        â”‚         â”‚ (å‡­è¯ç®¡ç†å±‚)                  â”‚
â”‚                    â”‚         â”‚                              â”‚
â”‚ â€¢ åˆ›å»ºé¡¹ç›®         â”‚         â”‚ â€¢ åŠ å¯†å‡­è¯                   â”‚
â”‚ â€¢ åˆ›å»ºæœåŠ¡         â”‚         â”‚ â€¢ ä¿å­˜é€šé“å‡­è¯                â”‚
â”‚ â€¢ åˆ›å»ºç¯å¢ƒ         â”‚         â”‚ â€¢ ç”Ÿæˆå®Œæ•´ç¯å˜                â”‚
â”‚ â€¢ è®¾ç½®ç¯å˜         â”‚         â”‚ â€¢ éªŒè¯å‡­è¯æœ‰æ•ˆæ€§              â”‚
â”‚ â€¢ è§¦å‘éƒ¨ç½²         â”‚         â”‚                              â”‚
â”‚ â€¢ æŸ¥è¯¢éƒ¨ç½²çŠ¶æ€     â”‚         â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Railway.app GraphQL API     â”‚
         â”‚  (å®é™…éƒ¨ç½²å¹³å°)               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    éƒ¨ç½²å®Œæˆå
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  DeploymentMonitoringâ€‹Service â”‚
         â”‚  (ç›‘æ§å’Œæ—¥å¿—æœåŠ¡)             â”‚
         â”‚                              â”‚
         â”‚ â€¢ è½®è¯¢éƒ¨ç½²çŠ¶æ€               â”‚
         â”‚ â€¢ è®¡ç®—éƒ¨ç½²è¿›åº¦               â”‚
         â”‚ â€¢ è®°å½•éƒ¨ç½²æ—¥å¿—               â”‚
         â”‚ â€¢ è¯„ä¼°å®ä¾‹å¥åº·çŠ¶æ€            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒæœåŠ¡è¯¦è§£

### 1. RailwayClient - API äº¤äº’å±‚

**ä½ç½®**: `src/services/railway/railway-client.ts`  
**è¡Œæ•°**: 400+  
**è´£ä»»**: ä¸ Railway.app GraphQL API äº¤äº’

#### ä¸»è¦æ–¹æ³•

| æ–¹æ³• | åŠŸèƒ½ | è¿”å› |
|------|------|------|
| `getProject(id)` | è·å–é¡¹ç›®ä¿¡æ¯ | RailwayProject |
| `createProject(name)` | åˆ›å»ºæ–°é¡¹ç›® | RailwayProject |
| `getProjectServices(id)` | è·å–é¡¹ç›®çš„æ‰€æœ‰æœåŠ¡ | RailwayService[] |
| `getService(id)` | è·å–æœåŠ¡è¯¦æƒ… | RailwayService |
| `getProjectEnvironments(id)` | è·å–é¡¹ç›®ç¯å¢ƒåˆ—è¡¨ | RailwayEnvironment[] |
| `createEnvironment(projectId, name)` | åˆ›å»ºç¯å¢ƒ | RailwayEnvironment |
| `setServiceVariables(serviceId, envId, vars)` | è®¾ç½®ç¯å¢ƒå˜é‡ | void |
| `getServiceVariables(serviceId, envId)` | è·å–ç¯å¢ƒå˜é‡ | Record<string, string> |
| `triggerRedeploy(serviceId, envId)` | è§¦å‘é‡æ–°éƒ¨ç½² | RailwayDeployment |
| `getDeploymentStatus(deploymentId)` | è·å–éƒ¨ç½²çŠ¶æ€ | RailwayDeployment |
| `deleteProject(id)` | åˆ é™¤é¡¹ç›® | void |
| `deleteService(id)` | åˆ é™¤æœåŠ¡ | void |

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
const client = new RailwayClient(process.env.RAILWAY_API_TOKEN);

// åˆ›å»ºé¡¹ç›®
const project = await client.createProject('my-instance');

// åˆ›å»ºç¯å¢ƒ
const env = await client.createEnvironment(project.id, 'production');

// è®¾ç½®ç¯å¢ƒå˜é‡
await client.setServiceVariables(serviceId, env.id, [
  { name: 'NODE_ENV', value: 'production' },
  { name: 'DEBUG', value: 'false' },
]);

// è§¦å‘éƒ¨ç½²
const deployment = await client.triggerRedeploy(serviceId, env.id);
```

---

### 2. RailwayCloneService - å…‹éš†æœåŠ¡ï¼ˆæ ¸å¿ƒï¼‰

**ä½ç½®**: `src/services/railway/railway-clone-service.ts`  
**è¡Œæ•°**: 350+  
**è´£ä»»**: åè°ƒæ•´ä¸ªå®ä¾‹åˆ›å»ºæµç¨‹ï¼ˆæ–¹æ¡ˆBï¼‰

#### å·¥ä½œæµç¨‹

```
ç”¨æˆ·åˆ›å»ºå®ä¾‹è¯·æ±‚
    â”‚
    â–¼
éªŒè¯æ¨¡æ¿é¡¹ç›®å­˜åœ¨
    â”‚
    â–¼
ç”Ÿæˆå”¯ä¸€çš„é¡¹ç›®/æœåŠ¡åç§°
    â”‚
    â–¼
åˆ›å»ºæ–°Railwayé¡¹ç›®
    â”‚
    â–¼
åˆ›å»ºç”Ÿäº§ç¯å¢ƒ
    â”‚
    â–¼
è·å–æ¨¡æ¿æœåŠ¡é…ç½®å’Œç¯å˜
    â”‚
    â–¼
å‡†å¤‡å®Œæ•´çš„ç¯å¢ƒå˜é‡
  (æ¨¡æ¿å˜é‡ + ç³»ç»Ÿå˜é‡ + é€šé“å‡­è¯ + è‡ªå®šä¹‰å˜é‡)
    â”‚
    â–¼
ä»æ¨¡æ¿åˆ›å»ºæœåŠ¡
    â”‚
    â–¼
æ³¨å…¥æ‰€æœ‰ç¯å¢ƒå˜é‡
    â”‚
    â–¼
è§¦å‘åˆå§‹éƒ¨ç½²
    â”‚
    â–¼
åœ¨æ•°æ®åº“è®°å½•å®ä¾‹
    â”‚
    â–¼
å¯åŠ¨ç›‘æ§æœåŠ¡
```

#### ä¸»è¦æ–¹æ³•

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `cloneAndCreateInstance()` | å…‹éš†åˆ›å»ºå®Œæ•´å®ä¾‹ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰ |
| `prepareEnvironmentVariables()` | å‡†å¤‡ç¯å¢ƒå˜é‡ |
| `getInstanceStatus()` | è·å–å®ä¾‹çŠ¶æ€ |
| `monitorDeployment()` | ç›‘æ§éƒ¨ç½²è¿›åº¦ |
| `updateInstanceVariables()` | æ›´æ–°ç¯å˜ |
| `redeployInstance()` | é‡æ–°éƒ¨ç½² |
| `deleteInstance()` | åˆ é™¤å®ä¾‹ |

#### å…‹éš†ç»“æœç¤ºä¾‹

```typescript
{
  success: true,
  projectId: "proj_123abc456def",
  projectName: "moltbot-basic-1708878234",
  serviceId: "svc_789xyz012uva",
  serviceName: "moltbot-basic-1708878234-service",
  environmentId: "env_bcd345efg678",
  deploymentId: "deploy_hij901klm234",
  publicUrl: "https://instance-001.railway.app",
  message: "Instance cloned successfully. Deployment in progress."
}
```

---

### 3. EnvironmentVariableService - ç¯å¢ƒå˜é‡ç®¡ç†

**ä½ç½®**: `src/services/railway/environment-variable-service.ts`  
**è¡Œæ•°**: 350+  
**è´£ä»»**: å‡­è¯åŠ å¯†ã€å­˜å‚¨å’Œè‡ªåŠ¨é…ç½®

#### å‡­è¯ç®¡ç†æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ é€šé“å‡­è¯
    â”‚
    â–¼
éªŒè¯å‡­è¯æ ¼å¼å’Œå¿…éœ€å­—æ®µ
    â”‚
    â–¼
ä½¿ç”¨AES-256åŠ å¯†æ•æ„Ÿä¿¡æ¯
    â”‚
    â–¼
å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
    â”‚
    â–¼
éœ€è¦æ—¶è§£å¯†å¹¶æ³¨å…¥ç¯å¢ƒå˜é‡
```

#### ä¸»è¦æ–¹æ³•

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `encryptCredentials()` | åŠ å¯†å‡­è¯ |
| `decryptCredentials()` | è§£å¯†å‡­è¯ |
| `saveChannelCredentials()` | ä¿å­˜é€šé“å‡­è¯ |
| `getChannelCredentials()` | è·å–å‡­è¯ |
| `getActiveChannelCredentials()` | è·å–æ‰€æœ‰æ´»è·ƒå‡­è¯ |
| `generateInstanceEnvironment()` | ç”Ÿæˆå®ä¾‹å®Œæ•´ç¯å¢ƒ |
| `validateChannelCredentials()` | éªŒè¯å‡­è¯æœ‰æ•ˆæ€§ |
| `updateChannelCredentials()` | æ›´æ–°å‡­è¯ |
| `disableChannelCredentials()` | ç¦ç”¨å‡­è¯ |
| `exportCredentialsConfig()` | å¯¼å‡ºé…ç½®ï¼ˆå¤‡ä»½ï¼‰ |
| `importCredentialsConfig()` | å¯¼å…¥é…ç½®ï¼ˆæ¢å¤ï¼‰ |

#### ç¯å¢ƒå˜é‡ç”Ÿæˆç¤ºä¾‹

```typescript
// ç”Ÿæˆçš„å®Œæ•´ç¯å¢ƒå˜é‡
{
  // åŸºç¡€ç³»ç»Ÿ
  NODE_ENV: "production",
  LOG_LEVEL: "info",
  ENVIRONMENT: "pro",
  
  // OpenClawç³»ç»Ÿå˜é‡
  OPENCLAW_USER_ID: "user_123",
  OPENCLAW_SUBSCRIPTION_ID: "sub_456",
  OPENCLAW_PLAN: "PRO",
  OPENCLAW_INSTANCE_NAME: "moltbot-pro-1708878234",
  OPENCLAW_CREATED_AT: "2026-02-25T10:30:34.000Z",
  
  // é€šé“é…ç½®
  FEISHU_CONFIG: '{"appId":"...","secret":"..."}',
  FEISHU_APP_ID: "...",
  FEISHU_SECRET: "***",
  
  // è®¡åˆ’ç‰¹æ€§
  PLAN_MAX_INSTANCES: "5",
  PLAN_MAX_CHANNELS: "10",
  PLAN_MAX_BANDWIDTH: "50",
  PLAN_SUPPORT_LEVEL: "priority"
}
```

#### æ”¯æŒçš„é€šé“ç±»å‹

| é€šé“ | å¿…éœ€å­—æ®µ | ç”¨é€” |
|------|---------|------|
| feishu | appId, secret | é£ä¹¦é›†æˆ |
| dingtalk | appKey, appSecret | é’‰é’‰é›†æˆ |
| wecom | corpId, secret | ä¼ä¸šå¾®ä¿¡é›†æˆ |
| telegram | token, botId | Telegramé›†æˆ |

---

### 4. DeploymentMonitoringService - éƒ¨ç½²ç›‘æ§

**ä½ç½®**: `src/services/railway/deployment-monitoring-service.ts`  
**è¡Œæ•°**: 300+  
**è´£ä»»**: è¿½è¸ªéƒ¨ç½²è¿›åº¦å’Œå®ä¾‹å¥åº·çŠ¶æ€

#### ç›‘æ§æµç¨‹

```
startMonitoring(instanceId)
    â”‚
    â–¼
æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡éƒ¨ç½²çŠ¶æ€
    â”‚
    â”œâ”€â–¶ æ›´æ–°deploymentStatus
    â”œâ”€â–¶ è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
    â”œâ”€â–¶ è¯„ä¼°å‰©ä½™æ—¶é—´
    â””â”€â–¶ è®°å½•æ—¥å¿—
    â”‚
éƒ¨ç½²å®Œæˆ(RUNNING)?
    â”‚
    â”œâ”€ æ˜¯ â–¶ åœæ­¢ç›‘æ§ï¼Œæ›´æ–°çŠ¶æ€ä¸ºRUNNING
    â”‚
    â””â”€ å¦ â–¶ ç»§ç»­ç›‘æ§
```

#### ä¸»è¦æ–¹æ³•

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `startMonitoring()` | å¯åŠ¨å¯¹å®ä¾‹çš„å®šæœŸç›‘æ§ |
| `stopMonitoring()` | åœæ­¢ç›‘æ§ |
| `checkDeploymentStatus()` | æ£€æŸ¥éƒ¨ç½²çŠ¶æ€ |
| `getMonitoringData()` | è·å–ç›‘æ§æ•°æ®å’Œè¿›åº¦ |
| `getInstanceHealth()` | è¯„ä¼°å®ä¾‹å¥åº·çŠ¶æ€ |
| `addDeploymentLog()` | è®°å½•éƒ¨ç½²æ—¥å¿— |
| `getDeploymentLogs()` | è·å–éƒ¨ç½²æ—¥å¿— |
| `startBatchMonitoring()` | æ‰¹é‡ç›‘æ§å¤šä¸ªå®ä¾‹ |
| `stopAllMonitoring()` | åœæ­¢æ‰€æœ‰ç›‘æ§ |

#### è¿›åº¦è®¡ç®—

| éƒ¨ç½²çŠ¶æ€ | è¿›åº¦ | ä¼°è®¡æ—¶é—´ |
|---------|------|---------|
| INITIALIZING | 10% | 60ç§’ |
| BUILDING | 30% | 180ç§’ |
| DEPLOYING | 70% | 120ç§’ |
| RUNNING | 100% | å®Œæˆ |
| FAILED | 0% | - |
| CRASHED | 0% | - |

#### ç›‘æ§æ•°æ®ç¤ºä¾‹

```typescript
{
  instanceId: "instance_123",
  projectId: "proj_456",
  deploymentId: "deploy_789",
  status: "BUILDING",
  progress: 30,
  logs: [
    "[2026-02-25T10:30:34.000Z] Deployment started",
    "[2026-02-25T10:30:45.000Z] Building docker image",
    "[2026-02-25T10:31:20.000Z] Image built successfully",
  ],
  estimatedTimeRemaining: 150,
  lastCheckedAt: "2026-02-25T10:31:25.000Z"
}
```

---

## ğŸŒ API ç«¯ç‚¹

### Railway å®ä¾‹ç®¡ç†è·¯ç”±

**åŸºç¡€è·¯å¾„**: `/api/railway`

#### 1. POST /instances - åˆ›å»ºå®ä¾‹

```http
POST /api/railway/instances HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "instanceName": "my-instance",
  "channelCredentials": {
    "feishu": {
      "appId": "cli_xxx",
      "secret": "xxx"
    }
  },
  "customVariables": [
    { "name": "CUSTOM_VAR", "value": "value" }
  ]
}
```

**å“åº”**: 201 Created

```json
{
  "success": true,
  "message": "Instance created successfully",
  "data": {
    "projectId": "proj_xxx",
    "projectName": "moltbot-basic-1708878234",
    "serviceId": "svc_xxx",
    "serviceName": "moltbot-basic-1708878234-service",
    "environmentId": "env_xxx",
    "deploymentId": "deploy_xxx",
    "message": "Instance cloned successfully. Deployment in progress."
  }
}
```

#### 2. GET /instances - è·å–æ‰€æœ‰å®ä¾‹

```http
GET /api/railway/instances HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
```

**å“åº”**: 200 OK

```json
{
  "success": true,
  "data": [
    {
      "id": "instance_123",
      "projectId": "proj_xxx",
      "projectName": "moltbot-basic-1708878234",
      "serviceName": "moltbot-service",
      "status": "RUNNING",
      "deploymentStatus": "RUNNING",
      "publicUrl": "https://instance-001.railway.app",
      "createdAt": "2026-02-25T10:30:34.000Z",
      "deploymentCompletedAt": "2026-02-25T10:35:20.000Z"
    }
  ],
  "count": 1
}
```

#### 3. GET /instances/:instanceId - è·å–å®ä¾‹è¯¦æƒ…

```http
GET /api/railway/instances/instance_123 HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
```

**å“åº”**: 200 OK

```json
{
  "success": true,
  "data": {
    "id": "instance_123",
    "projectId": "proj_xxx",
    "projectName": "moltbot-basic-1708878234",
    "serviceId": "svc_xxx",
    "serviceName": "moltbot-service",
    "environmentId": "env_xxx",
    "status": "RUNNING",
    "deploymentStatus": "RUNNING",
    "publicUrl": "https://instance-001.railway.app",
    "variables": {
      "NODE_ENV": "production",
      "OPENCLAW_PLAN": "BASIC"
    },
    "createdAt": "2026-02-25T10:30:34.000Z",
    "deploymentCompletedAt": "2026-02-25T10:35:20.000Z"
  }
}
```

#### 4. GET /instances/:instanceId/status - è·å–å®ä¾‹çŠ¶æ€

```http
GET /api/railway/instances/instance_123/status HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
```

**å“åº”**: 200 OK

```json
{
  "success": true,
  "data": {
    "instanceId": "instance_123",
    "status": "RUNNING",
    "deploymentStatus": "RUNNING",
    "monitoring": {
      "status": "RUNNING",
      "progress": 100,
      "logs": [],
      "estimatedTimeRemaining": 0
    },
    "health": {
      "status": "HEALTHY",
      "uptime": 3600,
      "lastCheckedAt": "2026-02-25T11:30:34.000Z"
    }
  }
}
```

#### 5. GET /instances/:instanceId/logs - è·å–éƒ¨ç½²æ—¥å¿—

```http
GET /api/railway/instances/instance_123/logs?limit=50 HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
```

**å“åº”**: 200 OK

```json
{
  "success": true,
  "data": {
    "instanceId": "instance_123",
    "logs": [
      "[2026-02-25T10:30:34.000Z] Deployment started",
      "[2026-02-25T10:30:45.000Z] Building docker image",
      "[2026-02-25T10:31:20.000Z] Image built successfully",
      "[2026-02-25T10:33:15.000Z] Deployment succeeded"
    ],
    "count": 4
  }
}
```

#### 6. PUT /instances/:instanceId - æ›´æ–°å®ä¾‹é…ç½®

```http
PUT /api/railway/instances/instance_123 HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "channelCredentials": {
    "feishu": {
      "appId": "cli_new",
      "secret": "new_secret"
    }
  }
}
```

**å“åº”**: 200 OK

```json
{
  "success": true,
  "message": "Instance updated successfully",
  "data": {
    "instanceId": "instance_123",
    "deploymentId": "deploy_new",
    "status": "Redeploying"
  }
}
```

#### 7. DELETE /instances/:instanceId - åˆ é™¤å®ä¾‹

```http
DELETE /api/railway/instances/instance_123 HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
```

**å“åº”**: 200 OK

```json
{
  "success": true,
  "message": "Instance deleted successfully"
}
```

#### 8. POST /instances/:instanceId/redeploy - é‡æ–°éƒ¨ç½²

```http
POST /api/railway/instances/instance_123/redeploy HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
```

**å“åº”**: 200 OK

```json
{
  "success": true,
  "message": "Redeployment triggered",
  "data": {
    "instanceId": "instance_123",
    "deploymentId": "deploy_new"
  }
}
```

#### 9. POST /instances/:instanceId/channels - é…ç½®é€šé“

```http
POST /api/railway/instances/instance_123/channels HTTP/1.1
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "channelType": "dingtalk",
  "credentials": {
    "appKey": "xxx",
    "appSecret": "xxx"
  }
}
```

**å“åº”**: 200 OK

```json
{
  "success": true,
  "message": "Channel dingtalk configured successfully"
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“æ¶æ„

### RailwayInstance è¡¨

```sql
CREATE TABLE railway_instance (
  id                    STRING PRIMARY KEY DEFAULT (cuid()),
  subscription_id       STRING NOT NULL,
  user_id               STRING NOT NULL,
  
  project_id            STRING UNIQUE NOT NULL,
  project_name          STRING NOT NULL,
  service_id            STRING NOT NULL,
  service_name          STRING NOT NULL,
  environment_id        STRING NOT NULL,
  environment_name      STRING DEFAULT 'production',
  
  deployment_id         STRING,
  deployment_status     STRING DEFAULT 'INITIALIZING',
  deployment_updated_at DATETIME DEFAULT now(),
  deployment_completed_at DATETIME,
  
  status                STRING DEFAULT 'INITIALIZING',
  public_url            STRING,
  
  variables             JSON DEFAULT '{}',
  logs                  JSON DEFAULT '[]',
  
  error_message         STRING,
  
  created_at            DATETIME DEFAULT now(),
  updated_at            DATETIME DEFAULT now(),
  deleted_at            DATETIME,
  
  FOREIGN KEY (subscription_id) REFERENCES subscription(id),
  FOREIGN KEY (user_id) REFERENCES user(id),
  INDEX idx_subscription_id (subscription_id),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_deployment_status (deployment_status)
);
```

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•æ–‡ä»¶ä½ç½®

`tests/services/railway-service.test.ts`

### æµ‹è¯•è¦†ç›–èŒƒå›´

#### RailwayCloneService æµ‹è¯•

- âœ… æˆåŠŸå…‹éš†é¡¹ç›®å¹¶åˆ›å»ºå®ä¾‹
- âœ… å¤„ç†å…‹éš†å¤±è´¥æƒ…å†µ
- âœ… ç›‘æ§éƒ¨ç½²è¿›åº¦ï¼ˆå¤šä¸ªçŠ¶æ€è½¬å˜ï¼‰
- âœ… åˆ é™¤å®ä¾‹

#### EnvironmentVariableService æµ‹è¯•

- âœ… åŠ å¯†å’Œè§£å¯†å‡­è¯
- âœ… éªŒè¯é£ä¹¦å‡­è¯
- âœ… ç”Ÿæˆå®ä¾‹å®Œæ•´ç¯å¢ƒå˜é‡
- âœ… ä¿å­˜é€šé“å‡­è¯
- âœ… åŠ å¯†æ•æ„Ÿä¿¡æ¯

#### DeploymentMonitoringService æµ‹è¯•

- âœ… è®¡ç®—éƒ¨ç½²è¿›åº¦
- âœ… è¯„ä¼°å®ä¾‹å¥åº·çŠ¶æ€
- âœ… è·å–éƒ¨ç½²æ—¥å¿—
- âœ… è®°å½•éƒ¨ç½²æ—¥å¿—
- âœ… è·å–æ‰€æœ‰ç›‘æ§çš„å®ä¾‹

#### RailwayClient æµ‹è¯•

- âœ… API token éªŒè¯
- âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰Phase 3æµ‹è¯•
npm test -- railway-service.test.ts

# è¿è¡Œç‰¹å®šæµ‹è¯•å¥—ä»¶
npm test -- railway-service.test.ts -t "RailwayCloneService"

# è¿è¡Œå¸¦è¦†ç›–ç‡çš„æµ‹è¯•
npm test -- railway-service.test.ts --coverage
```

---

## ğŸ” å®‰å…¨æ€§è€ƒè™‘

### 1. å‡­è¯åŠ å¯†

```typescript
// æ‰€æœ‰é€šé“å‡­è¯ä½¿ç”¨AES-256-CBCåŠ å¯†å­˜å‚¨
const encrypted = envVarService.encryptCredentials({
  appId: 'xxx',
  secret: 'xxx'
});

// æ•°æ®åº“å­˜å‚¨åŠ å¯†æ•°æ®
await prisma.channelCredential.create({
  data: {
    credentialsEncrypted: encrypted, // åŠ å¯†åå­˜å‚¨
    isActive: true
  }
});
```

### 2. ç¯å¢ƒå˜é‡éš”ç¦»

```typescript
// æ•æ„Ÿå˜é‡æ ‡è®°ä¸º isSecret
const variables = [
  { name: 'FEISHU_SECRET', value: 'xxx', isSecret: true },  // ä¸ä¼šè®°å½•
  { name: 'NODE_ENV', value: 'production', isSecret: false }  // ä¼šè®°å½•
];

// æ•°æ®åº“ä¸­æ•æ„Ÿå˜é‡æ˜¾ç¤ºä¸º ***
instance.variables = {
  FEISHU_SECRET: '***',
  NODE_ENV: 'production'
};
```

### 3. API è®¤è¯

```typescript
// æ‰€æœ‰Railwayç«¯ç‚¹éœ€è¦JWTè®¤è¯
router.get('/instances/:instanceId', authMiddleware, async (req, res) => {
  const userId = (req as any).user?.id;
  
  // éªŒè¯ç”¨æˆ·æƒé™
  if (instance.userId !== userId) {
    return res.status(404).json({ success: false });
  }
});
```

### 4. é€Ÿç‡é™åˆ¶

å»ºè®®æ·»åŠ é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶ï¼š

```typescript
import rateLimit from 'express-rate-limit';

const instanceCreationLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 5, // æœ€å¤šåˆ›å»º5ä¸ªå®ä¾‹
  message: 'Too many instances created, please try again later'
});

router.post('/instances', instanceCreationLimiter, authMiddleware, ...);
```

---

## ğŸš€ éƒ¨ç½²è¦æ±‚

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```bash
# Railway API
RAILWAY_API_TOKEN=your_railway_api_token
RAILWAY_TEMPLATE_PROJECT_ID=your_template_project_id
RAILWAY_TEMPLATE_SERVICE_ID=your_template_service_id

# åŠ å¯†å¯†é’¥
APP_SECRET=your_app_secret_min_32_characters_here
```

### å‰ç½®æ¡ä»¶

1. âœ… Railway.app è´¦æˆ·å·²åˆ›å»º
2. âœ… è·å– API Token
3. âœ… åˆ›å»ºæ¨¡æ¿é¡¹ç›®å’ŒæœåŠ¡
4. âœ… é…ç½®æ¨¡æ¿çš„åŸºç¡€ç¯å¢ƒå˜é‡
5. âœ… Phase 1-2 å·²å®Œå…¨å®ç°

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æ“ä½œ | é¢„æœŸæ—¶é—´ | è¯´æ˜ |
|------|---------|------|
| åˆ›å»ºå®ä¾‹ | 2-3 åˆ†é’Ÿ | åŒ…æ‹¬éƒ¨ç½² |
| æ›´æ–°å‡­è¯ | 30-60 ç§’ | è§¦å‘é‡æ–°éƒ¨ç½² |
| åˆ é™¤å®ä¾‹ | 10-20 ç§’ | æ¸…ç†èµ„æº |
| ç›‘æ§æ£€æŸ¥ | < 1 ç§’ | æ¯30ç§’æ‰§è¡Œ |

---

## ğŸ”„ å·¥ä½œæµç¤ºä¾‹

### å®Œæ•´çš„å®ä¾‹åˆ›å»ºæµç¨‹

```typescript
// 1. ç”¨æˆ·è®¢é˜…äº† PRO è®¡åˆ’
const user = await prisma.user.findUnique({ where: { id: 'user_123' } });
const subscription = await prisma.subscription.findFirst({
  where: { userId: user.id, status: 'ACTIVE' },
});

// 2. è°ƒç”¨åˆ›å»ºå®ä¾‹API
const response = await fetch('/api/railway/instances', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    instanceName: 'my-chatbot',
    channelCredentials: {
      feishu: {
        appId: 'cli_xxx',
        secret: 'xxx'
      }
    }
  })
});

// 3. æœåŠ¡ç«¯å¤„ç†
// a. éªŒè¯è®¢é˜…çŠ¶æ€ âœ“
// b. éªŒè¯å®ä¾‹æ•°é‡é™åˆ¶ âœ“
// c. éªŒè¯å‡­è¯æ ¼å¼ âœ“
// d. å…‹éš†æ¨¡æ¿é¡¹ç›® âœ“
// e. åˆ›å»ºç”Ÿäº§ç¯å¢ƒ âœ“
// f. æ³¨å…¥ç¯å¢ƒå˜é‡ âœ“
// g. è§¦å‘éƒ¨ç½² âœ“
// h. è®°å½•åˆ°æ•°æ®åº“ âœ“
// i. å¯åŠ¨ç›‘æ§ âœ“

const data = await response.json();
console.log('Project ID:', data.data.projectId);
console.log('Deployment ID:', data.data.deploymentId);

// 4. æŸ¥è¯¢éƒ¨ç½²çŠ¶æ€
const statusResponse = await fetch(
  `/api/railway/instances/${data.data.projectId}/status`,
  { headers: { 'Authorization': `Bearer ${token}` } }
);

const statusData = await statusResponse.json();
console.log('Progress:', statusData.data.monitoring.progress + '%');
console.log('Status:', statusData.data.monitoring.status);

// 5. è½®è¯¢ç›´åˆ°å®Œæˆ
setInterval(async () => {
  const status = await fetch(
    `/api/railway/instances/${data.data.projectId}/status`,
    { headers: { 'Authorization': `Bearer ${token}` } }
  ).then(r => r.json());
  
  if (status.data.health.status === 'HEALTHY') {
    console.log('âœ… å®ä¾‹å·²å°±ç»ª!');
    console.log('URL:', status.data.publicUrl);
  }
}, 10000);
```

---

## ğŸ“ˆ æ‰©å±•æ€§è®¾è®¡

### æ”¯æŒæ·»åŠ æ–°çš„é€šé“ç±»å‹

```typescript
// 1. åœ¨ validateChannelCredentials ä¸­æ·»åŠ è§„åˆ™
const requiredFields = {
  newchannel: ['field1', 'field2'],
};

// 2. å°±è‡ªåŠ¨æ”¯æŒäº†ï¼
await envVarService.saveChannelCredentials(
  subId,
  'newchannel',
  { field1: 'value1', field2: 'value2' }
);
```

### æ”¯æŒè‡ªå®šä¹‰éƒ¨ç½²é…ç½®

```typescript
// ä¼ é€’è‡ªå®šä¹‰å˜é‡
await cloneService.cloneAndCreateInstance({
  // ...
  customVariables: [
    { name: 'CUSTOM_DOMAIN', value: 'https://my-domain.com' },
    { name: 'WEBHOOK_SECRET', value: 'secret123', isSecret: true },
  ],
});
```

---

## âš ï¸ æ•…éšœå¤„ç†

### éƒ¨ç½²å¤±è´¥æ¢å¤

```typescript
// å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œå¯ä»¥ï¼š
// 1. æŸ¥çœ‹æ—¥å¿—äº†è§£åŸå› 
const logs = await fetch('/api/railway/instances/{id}/logs')
  .then(r => r.json());
console.log(logs.data.logs);

// 2. æ›´æ–°é…ç½®
await fetch('/api/railway/instances/{id}', {
  method: 'PUT',
  body: JSON.stringify({ channelCredentials: {...} })
});

// 3. é‡æ–°éƒ¨ç½²
await fetch('/api/railway/instances/{id}/redeploy', {
  method: 'POST'
});
```

---

## ğŸ“ é…ç½®æ¸…å•

- âœ… Railway API Client å®ç°
- âœ… å…‹éš†æœåŠ¡ï¼ˆæ–¹æ¡ˆBï¼‰å®ç°
- âœ… ç¯å¢ƒå˜é‡ç®¡ç†ç³»ç»Ÿ
- âœ… éƒ¨ç½²ç›‘æ§æœåŠ¡
- âœ… å®Œæ•´çš„APIè·¯ç”±
- âœ… æ•°æ®åº“æ¶æ„æ›´æ–°
- âœ… å…¨é¢çš„å•å…ƒæµ‹è¯•
- âœ… å®‰å…¨æ€§å®ç°
- âœ… æ–‡æ¡£å®Œæ•´

**Phase 3 è¿›åº¦: 100% âœ…**

---

## ğŸ¯ ä¸‹ä¸€æ­¥

Phase 4 å°†å®ç°ï¼š
- å‰ç«¯UIç»„ä»¶åº“
- å®ä¾‹ç®¡ç†ç•Œé¢
- å®æ—¶ä»ªè¡¨æ¿
- ç”¨æˆ·å‹å¥½çš„å¼•å¯¼æµç¨‹

**é¢„è®¡å®Œæˆ**: 2026å¹´3æœˆ4æ—¥
