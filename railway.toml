# OpenClaw 订阅网站 Railway 部署配置

[build]
  builder = "dockerfile"
  dockerfilePath = "Dockerfile.railway"
  context = "."

[deploy]
  startCommand = "bash -c 'echo \"=== 启动订阅网站 ===\"; export NODE_ENV=production; export PORT=${PORT:-3000}; echo \"使用端口: ${PORT:-3000}\"; if [ ! -z \"$DATABASE_URL\" ]; then echo \"=== 运行数据库迁移 ===\"; npx prisma migrate deploy; fi; echo \"=== 启动应用 ===\"; exec node dist/index.js'"
  restartPolicyType = "always"
  restartPolicyMaxRetries = 10

[env]
  NODE_ENV = "production"
  PORT = "3000"
  
  # 认证配置
  JWT_SECRET = "${JWT_SECRET}"
  JWT_REFRESH_SECRET = "${JWT_REFRESH_SECRET}"
  
  # 数据库配置
  # Railway 会自动注入数据库连接信息
  DATABASE_URL = "${DATABASE_URL:-postgresql://postgres:password@shinkansen.proxy.rlwy.net:27692/railway}"
  
  # 支付配置
  ALIPAY_APP_ID = "${ALIPAY_APP_ID}"
  ALIPAY_PRIVATE_KEY = "${ALIPAY_PRIVATE_KEY}"
  ALIPAY_PUBLIC_KEY = "${ALIPAY_PUBLIC_KEY}"
  ALIPAY_NOTIFY_URL = "${ALIPAY_NOTIFY_URL}"
  
  # 微信支付
  WECHAT_APP_ID = "${WECHAT_APP_ID}"
  WECHAT_MCH_ID = "${WECHAT_MCH_ID}"
  WECHAT_API_KEY = "${WECHAT_API_KEY}"
  WECHAT_PRIVATE_KEY = "${WECHAT_PRIVATE_KEY}"
  WECHAT_SERIAL_NO = "${WECHAT_SERIAL_NO}"
  WECHAT_APIV3_KEY = "${WECHAT_APIV3_KEY}"
  WECHAT_NOTIFY_URL = "${WECHAT_NOTIFY_URL}"
  
  # Railway 配置
RAILWAY_PUBLIC_DOMAIN = "${RAILWAY_PUBLIC_DOMAIN:-openclaw-subscription-site-production.up.railway.app}"
  
  # 前端环境变量
  VITE_API_URL = "${RAILWAY_PUBLIC_DOMAIN}/api"
  
  # 应用配置
  APP_NAME = "OpenClaw订阅网站"
  APP_VERSION = "1.0.0"
  APP_URL = "${RAILWAY_PUBLIC_DOMAIN}"
  
  # 日志配置
  LOG_LEVEL = "debug"
  LOG_LEVEL = "info"
  LOG_FORMAT = "json"

[[services]]
  name = "openclaw-subscription-site"
  template = "nodejs"
  
  [[services.build]]
    builder = "docker"
    
  [[services.deploy]]
    startCommand = "bash -c 'echo \"=== 启动订阅网站 ===\"; export NODE_ENV=production; export PORT=${PORT:-3000}; echo \"使用端口: ${PORT:-3000}\"; exec node server.js'"
    memory = "512MB"
    restart = "always"
    
  [[services.healthcheck]]
    interval = 30
    timeout = 10
    path = "/health"
    port = 3000

[[plugins]]
  name = "postgres"
  version = "14"

[[plugins]]
  name = "redis"
  version = "7"